<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Revision Tracker — Enhanced</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0f1724">
  <style>
    :root{ --bg:#071028; --card:#0f1724; --muted:#93a4b8; --accent1:#06b6d4; --accent2:#10b981; }
    html,body{height:100%}
    body{ margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(180deg, #071028 0%, #020617 100%); color: #e6eef6; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; padding-bottom:140px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border: 1px solid rgba(255,255,255,0.03); border-radius: 14px; box-shadow: 0 6px 24px rgba(2,6,23,0.6); overflow: hidden; }
    .accent-rail { width:6px; background: linear-gradient(180deg,var(--accent2),var(--accent1)); border-radius: 6px; margin-right: 12px; }
    .pbar { height:10px; background:#0b1220; border-radius:8px; overflow:hidden; }
    .pbar .fill { height:100%; width:0%; transition: width .6s ease; background: linear-gradient(90deg,var(--accent2),var(--accent1)); }
    .circle { width:28px; height:28px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; border:2px solid rgba(255,255,255,0.08); cursor:pointer; }
    .circle.done { background: linear-gradient(90deg,var(--accent2),var(--accent1)); border: none; box-shadow: 0 6px 18px rgba(6,182,212,0.12); }
    .tiny { font-size: .78rem; color: var(--muted); }
    .muted { color: var(--muted); }
    .fade-up { transform: translateY(8px); opacity:0; animation: fadeUp .45s ease forwards; }
    @keyframes fadeUp { to { transform: translateY(0); opacity:1; } }
    .bottom-nav { position: fixed; left: 50%; transform: translateX(-50%); bottom: 12px; width: 96%; max-width:960px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius: 14px; border: 1px solid rgba(255,255,255,0.03); display:flex; align-items:center; justify-content:space-between; padding:8px 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); z-index:50; }
    .fab { position: fixed; right: 22px; bottom: 140px; width:56px; height:56px; border-radius: 50%; display:flex; align-items:center; justify-content:center; background: linear-gradient(90deg,var(--accent2),var(--accent1)); color: #021117; font-weight:700; box-shadow: 0 12px 36px rgba(6,182,212,0.12); cursor:pointer; z-index:60; }
    textarea.note { width:100%; min-height:100px; padding:10px; border-radius:8px; background:transparent; color:inherit; border:1px solid rgba(255,255,255,0.04); }
    .chip { padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); font-weight:600; }
    .small-input{ background:transparent; color:inherit; border:1px solid rgba(255,255,255,0.04); padding:6px 8px; border-radius:6px; }
  </style>
</head>
<body>
<main class="max-w-4xl mx-auto px-4 pt-6">
  <header class="flex items-center justify-between mb-4">
    <div>
      <div class="tiny muted">UPSC Revision</div>
      <h1 class="text-2xl font-bold">Revision Dashboard</h1>
    </div>
    <div class="flex items-center gap-3">
      <button id="exportBtn" class="chip">Export</button>
      <button id="importBtn" class="chip">Import</button>
      <button id="addSubBtn" class="chip">+ Subject</button>
      <button id="delSubBtn" class="chip">Delete Subject</button>
    </div>
  </header>

  <section class="flex items-center gap-3 mb-4">
    <div id="tabs" class="flex gap-3 overflow-auto"></div>
    <div class="flex-1"></div>
    <div class="tiny muted">Dark UI • PWA</div>
  </section>

  <section class="card p-4 mb-4 grid grid-cols-1 md:grid-cols-2 gap-4 fade-up">
    <div class="flex items-center gap-4">
      <div style="width:120px;height:120px;position:relative">
        <canvas id="donut" width="120" height="120"></canvas>
        <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center">
          <div id="donutPct" class="text-xl font-bold">0%</div>
          <div class="tiny muted">Completed</div>
        </div>
      </div>
      <div class="flex-1">
        <div class="tiny muted mb-2">Progress trend (last weeks)</div>
        <canvas id="trend" height="120"></canvas>
      </div>
    </div>
    <div>
      <div class="flex items-center justify-between mb-2">
        <div class="font-semibold">Subject overview</div>
        <div class="tiny muted" id="overallCount">0 / 0 topics</div>
      </div>
      <div id="sectionSummary" class="space-y-3 max-h-60 overflow-y-auto pr-2"></div>
    </div>
  </section>

  <section id="sections" class="space-y-3"></section>
</main>

<div class="fab" id="fabAdd" title="Add custom topic">＋</div>

<div class="bottom-nav">
  <div class="flex items-center gap-2">
    <button class="chip" id="btnDaily">Daily</button>
    <button class="chip" id="btnWeekly">Weekly</button>
    <button class="chip" id="btnMonthly">Monthly</button>
  </div>
  <div class="flex items-center gap-2">
    <button class="chip" id="btnSettings">Settings</button>
  </div>
</div>

<div id="settingsModal" class="fixed inset-0 hidden items-center justify-center z-60">
  <div class="absolute inset-0 bg-black/60"></div>
  <div class="relative w-full max-w-lg p-4">
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <div class="font-semibold">Settings & Tools</div>
        <div>
          <button id="closeSettings" class="chip">Close</button>
        </div>
      </div>
      <div class="space-y-3">
        <div>
          <div class="font-medium tiny muted">Pomodoro</div>
          <div class="flex items-center gap-2 mt-2">
            <button id="startPom" class="chip">Start 25m</button>
            <button id="stopPom" class="chip">Stop</button>
            <div class="tiny muted" id="pomTimer">00:00</div>
            <button id="silencePom" class="chip">Silence Alarm</button>
          </div>
        </div>
        <div>
          <div class="font-medium tiny muted">Features</div>
          <div class="flex items-center gap-3 mt-2">
            <label class="tiny muted"><input type="checkbox" id="toggleCycles" class="mr-2"> Enable R1/R2/R3</label>
            <label class="tiny muted"><input type="checkbox" id="toggleStreak" class="mr-2" checked> Enable Streak</label>
          </div>
        </div>
        <div>
          <div class="font-medium tiny muted">Import / Reset</div>
          <div class="flex gap-2 mt-2">
            <input id="importFile" type="file" accept="application/json" class="tiny" />
            <button id="resetSub" class="chip">Reset Subject</button>
            <button id="resetAll" class="chip">Reset All</button>
          </div>
        </div>
        <div>
          <div class="font-medium tiny muted">Notifications</div>
          <div class="flex items-center gap-3 mt-2">
            <button id="enableNotif" class="chip">Enable Browser Notifications</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="noteModal" class="fixed inset-0 hidden items-center justify-center z-70">
  <div class="absolute inset-0 bg-black/60"></div>
  <div class="relative max-w-lg w-full p-4">
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <div><b id="noteTitle">Notes</b></div>
        <div>
          <button id="saveNote" class="chip">Save</button>
          <button id="closeNote" class="chip">Close</button>
        </div>
      </div>
      <textarea id="noteEditor" class="note" placeholder="Type notes here..."></textarea>
    </div>
  </div>
</div>

<!-- hidden audio for pomodoro alarm -->
<audio id="pomAlarm" loop>
  <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
</audio>

<script>
/* --------------------------- Model & Storage helpers --------------------------- */
const SUBJECTS = {
  anthropology: { title: "Anthropology", sections: [ { title: "Meaning, Scope, Development", topics: ["Meaning of Anthropology","Scope & Branches","Historical development"] }, { title: "Research Methods", topics: ["Fieldwork","Ethnography","Sampling & Methods"] } ] },
  history: { title: "History (Ancient & Modern)", sections: [ { title: "Ancient India", topics: ["Prehistoric cultures","Indus Valley (Harappan)"] }, { title: "Modern India", topics: ["Advent of Europeans","British expansion"] } ] }
};

let currentSubjectKey = localStorage.getItem('rt-sub') || Object.keys(SUBJECTS)[0];
let cyclesEnabled = JSON.parse(localStorage.getItem('rt-cycles') || 'true');
let streakEnabled = JSON.parse(localStorage.getItem('rt-streak') || 'true');

function keyDone(sub,si,ti){ return `rt:${sub}:s${si}:t${ti}:done`; }
function keyNote(sub,si,ti){ return `rt:${sub}:s${si}:t${ti}:note`; }
function keyCycles(sub,si,ti){ return `rt:${sub}:s${si}:t${ti}:cycles`; }
function keySchedule(sub,si,ti){ return `rt:${sub}:s${si}:t${ti}:sched`; }
function keyStreak(){ return `rt:streak`; }

/* --------------------------- DOM refs --------------------------- */
const elt = id => document.getElementById(id);
const sectionsEl = elt('sections'), summaryEl = elt('sectionSummary');
const donutPctEl = elt('donutPct'), overallCountEl = elt('overallCount');
let donutChart = null, trendChart = null;

/* --------------------------- Render Tabs --------------------------- */
function renderTabs(){ const tabs = document.getElementById('tabs'); tabs.innerHTML=''; Object.keys(SUBJECTS).forEach(k=>{ const btn = document.createElement('div'); btn.className='chip cursor-pointer'; btn.textContent = SUBJECTS[k].title; btn.dataset.sub = k; if(k===currentSubjectKey) btn.classList.add('active'); btn.addEventListener('click', ()=>{ currentSubjectKey = k; localStorage.setItem('rt-sub',k); renderAll(); }); tabs.appendChild(btn); }); }

/* --------------------------- Calc & render top */
function calcTotals(){ const model = SUBJECTS[currentSubjectKey]; let total=0, done=0; model.sections.forEach((sec,si)=> sec.topics.forEach((t,ti)=>{ total++; if(localStorage.getItem(keyDone(currentSubjectKey,si,ti)) === 'true') done++; })); return {done,total,pct: total? Math.round(done/total*100):0}; }

function renderTop(){ const totals = calcTotals(); overallCountEl.textContent = `${totals.done} / ${totals.total} topics`; donutPctEl.textContent = `${totals.pct}%`; const ddata = [totals.done, Math.max(0, totals.total - totals.done)]; if(donutChart) donutChart.destroy(); donutChart = new Chart(elt('donut').getContext('2d'), { type:'doughnut', data:{ labels:['Done','Pending'], datasets:[{ data:ddata, backgroundColor:['#10b981','#475569'] }] }, options:{ cutout:'78%', plugins:{ legend:{ display:false } } } }); const trend = generateTrend(totals.done, totals.total); if(trendChart) trendChart.destroy(); trendChart = new Chart(elt('trend').getContext('2d'), { type:'line', data:{ labels:trend.labels, datasets:[{ data:trend.data, tension:0.35, borderColor:'#06b6d4', backgroundColor:'rgba(6,182,212,0.08)', fill:true }] }, options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, suggestedMax: Math.max(3, ...trend.data) } } } }); // overview
  summaryEl.innerHTML=''; SUBJECTS[currentSubjectKey].sections.forEach((sec,si)=>{ let secTotal = sec.topics.length, secDone=0; sec.topics.forEach((t,ti)=>{ if(localStorage.getItem(keyDone(currentSubjectKey,si,ti))==='true') secDone++; }); const pct = secTotal? Math.round(secDone/secTotal*100):0; const div = document.createElement('div'); div.className='flex items-center gap-3 card p-3'; div.innerHTML = `
      <div class="accent-rail" aria-hidden></div>
      <div class="flex-1">
        <div class="flex items-center justify-between mb-1">
          <div class="font-medium">${sec.title}</div>
          <div class="tiny muted">${pct}%</div>
        </div>
        <div class="pbar"><div class="fill" style="width:${pct}%"></div></div>
      </div>
      <div class="tiny muted">${secDone}/${secTotal}</div>`; summaryEl.appendChild(div); }); }

/* --------------------------- Render Sections & topics (editable) --------------------------- */
function renderSections(){ sectionsEl.innerHTML=''; const model = SUBJECTS[currentSubjectKey]; model.sections.forEach((sec,si)=>{ const container = document.createElement('div'); container.className='card p-3 fade-up'; container.innerHTML = `
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-3">
          <div style="width:6px;height:40px;border-radius:6px;background:linear-gradient(180deg,var(--accent2),var(--accent1))"></div>
          <div><div class="font-semibold">${sec.title}</div><div class="tiny muted">${sec.topics.length} topics</div></div>
        </div>
        <div class="tiny muted">Section</div>
      </div>
      <div class="space-y-3" id="sec-${si}"></div>
      <div class="mt-3 flex gap-2"><input class="small-input" id="new-topic-${si}" placeholder="New topic title"/><button class="chip" id="add-topic-${si}">Add topic</button></div>
    `; sectionsEl.appendChild(container);
    const listEl = container.querySelector(`#sec-${si}`);
    // add topic handler
    container.querySelector(`#add-topic-${si}`).addEventListener('click', ()=>{
      const v = container.querySelector(`#new-topic-${si}`).value.trim(); if(!v) return alert('Enter a title'); SUBJECTS[currentSubjectKey].sections[si].topics.push(v); container.querySelector(`#new-topic-${si}`).value=''; persistSubjects(); renderAll(); });
    sec.topics.forEach((topic,ti)=>{
      const done = localStorage.getItem(keyDone(currentSubjectKey,si,ti)) === 'true';
      const note = localStorage.getItem(keyNote(currentSubjectKey,si,ti)) || '';
      const cycles = JSON.parse(localStorage.getItem(keyCycles(currentSubjectKey,si,ti) || '{}') || '{}');
      const sched = JSON.parse(localStorage.getItem(keySchedule(currentSubjectKey,si,ti) || '{}') || '{}');
      const nextDue = sched.next || '';
      const freq = sched.freq || '';
      const row = document.createElement('div');
      row.className = 'flex items-center justify-between gap-3';
      row.innerHTML = `
        <div class="flex items-start gap-3">
          <div style="width:4px;height:56px;border-radius:6px;background:linear-gradient(180deg,var(--accent2),var(--accent1));margin-top:6px"></div>
          <div class="flex-1">
            <div class="flex items-center justify-between"><div class="font-medium topic-title">${topic}</div>
              <div class="tiny muted">${nextDue? 'Next: '+nextDue : ''}</div></div>
            <div class="tiny muted note-preview">${note? note.slice(0,80) : 'No notes yet'}</div>
            <div class="pbar mt-2"><div class="fill" style="width:${done?100:0}%"></div></div>
            <div class="mt-2 tiny muted">Schedule: <select class="sched-freq" data-si="${si}" data-ti="${ti}">
              <option value="">--</option>
              <option value="daily" ${freq==='daily'?'selected':''}>Daily</option>
              <option value="weekly" ${freq==='weekly'?'selected':''}>Weekly</option>
              <option value="monthly" ${freq==='monthly'?'selected':''}>Monthly</option>
            </select>
            <input type="date" class="sched-date ml-2" data-si="${si}" data-ti="${ti}" value="${nextDue}"></div>
          </div>
        </div>
        <div class="flex flex-col items-center gap-2">
          <div class="circle ${done ? 'done' : ''}" data-si="${si}" data-ti="${ti}" title="Mark done">${done? '✓' : ''}</div>
          <div class="flex gap-2"><button class="tiny muted open-note" data-si="${si}" data-ti="${ti}">Notes</button><button class="tiny muted edit-topic" data-si="${si}" data-ti="${ti}">Edit</button><button class="tiny muted del-topic" data-si="${si}" data-ti="${ti}">Delete</button></div>
          <div class="rev-cycles mt-2">
            <label><input type="checkbox" class="c-r1" data-si="${si}" data-ti="${ti}" ${cycles.r1? 'checked' : ''}/>R1</label>
            <label><input type="checkbox" class="c-r2" data-si="${si}" data-ti="${ti}" ${cycles.r2? 'checked' : ''}/>R2</label>
            <label><input type="checkbox" class="c-r3" data-si="${si}" data-ti="${ti}" ${cycles.r3? 'checked' : ''}/>R3</label>
          </div>
        </div>
      `;
      listEl.appendChild(row);

      // handlers: mark done -> automatic cycle tick + set next due if scheduled
      row.querySelector('.circle').addEventListener('click', (e)=>{
        const key = keyDone(currentSubjectKey,si,ti);
        const wasDone = localStorage.getItem(key) === 'true';
        const newVal = !wasDone;
        localStorage.setItem(key, newVal ? 'true' : 'false');
        if(newVal){ // completed now
          if(streakEnabled) updateStreak();
          // automatic cycle tick
          if(cyclesEnabled){
            const cd = JSON.parse(localStorage.getItem(keyCycles(currentSubjectKey,si,ti) || '{}') || '{}');
            if(!cd.r1) cd.r1 = true;
            else if(!cd.r2) cd.r2 = true;
            else if(!cd.r3) cd.r3 = true;
            localStorage.setItem(keyCycles(currentSubjectKey,si,ti), JSON.stringify(cd));
          }
          // if scheduled, push nextDue forward depending on freq
          const s = JSON.parse(localStorage.getItem(keySchedule(currentSubjectKey,si,ti) || '{}') || '{}');
          if(s.freq && s.next){
            const next = advanceDate(s.next, s.freq);
            s.next = next; localStorage.setItem(keySchedule(currentSubjectKey,si,ti), JSON.stringify(s));
          }
        }
        renderAll();
      });

      // open note
      row.querySelector('.open-note').addEventListener('click', ()=> openNote(si,ti,topic));

      // edit topic (rename)
      row.querySelector('.edit-topic').addEventListener('click', ()=>{
        const nv = prompt('Edit topic title', topic); if(nv && nv.trim()){ SUBJECTS[currentSubjectKey].sections[si].topics[ti] = nv.trim(); persistSubjects(); renderAll(); }
      });

      // delete topic
      row.querySelector('.del-topic').addEventListener('click', ()=>{
        if(!confirm('Delete this topic?')) return; SUBJECTS[currentSubjectKey].sections[si].topics.splice(ti,1); // remove related keys
        localStorage.removeItem(keyDone(currentSubjectKey,si,ti)); localStorage.removeItem(keyNote(currentSubjectKey,si,ti)); localStorage.removeItem(keyCycles(currentSubjectKey,si,ti)); localStorage.removeItem(keySchedule(currentSubjectKey,si,ti)); persistSubjects(); renderAll();
      });

      // schedule controls
      const sel = row.querySelector('.sched-freq'); const dateInp = row.querySelector('.sched-date');
      sel.addEventListener('change', ()=>{
        const s = JSON.parse(localStorage.getItem(keySchedule(currentSubjectKey,si,ti) || '{}') || '{}'); s.freq = sel.value || ''; if(!s.next) s.next = dateInp.value || ''; localStorage.setItem(keySchedule(currentSubjectKey,si,ti), JSON.stringify(s)); renderAll();
      });
      dateInp.addEventListener('change', ()=>{
        const s = JSON.parse(localStorage.getItem(keySchedule(currentSubjectKey,si,ti) || '{}') || '{}'); s.next = dateInp.value || ''; if(!s.freq) s.freq = '' ; localStorage.setItem(keySchedule(currentSubjectKey,si,ti), JSON.stringify(s)); renderAll();
      });

      // cycles checkboxes
      ['r1','r2','r3'].forEach(r=>{ const cb = row.querySelector('.c-'+r); cb.addEventListener('change', ()=>{ const cd = { r1: !!row.querySelector('.c-r1').checked, r2: !!row.querySelector('.c-r2').checked, r3: !!row.querySelector('.c-r3').checked }; localStorage.setItem(keyCycles(currentSubjectKey,si,ti), JSON.stringify(cd)); renderTop(); }); });

    });
  });
}

/* --------------------------- Notes modal --------------------------- */
function openNote(si,ti,title){ elt('noteTitle').textContent = title; elt('noteEditor').value = localStorage.getItem(keyNote(currentSubjectKey,si,ti)) || ''; elt('noteModal').classList.remove('hidden'); elt('noteModal').classList.add('flex'); elt('saveNote').onclick = () => { const v = elt('noteEditor').value.trim(); if(!v) localStorage.removeItem(keyNote(currentSubjectKey,si,ti)); else localStorage.setItem(keyNote(currentSubjectKey,si,ti), v); elt('noteModal').classList.add('hidden'); renderAll(); }; elt('closeNote').onclick = () => { elt('noteModal').classList.add('hidden'); } }

/* --------------------------- Streak --------------------------- */
function updateStreak(){ const today = new Date().toISOString().slice(0,10); const data = JSON.parse(localStorage.getItem(keyStreak()) || '{"last":"","count":0}'); if(data.last === today) return; data.last = today; data.count = (data.count || 0) + 1; localStorage.setItem(keyStreak(), JSON.stringify(data)); }

/* --------------------------- Trend generator --------------------------- */
function generateTrend(done,total){ const weeks=6; const labels=[]; const data=[]; for(let i=weeks;i>0;i--){ labels.push('W-'+i); data.push(Math.round(Math.max(0,(total?done/total:0)*5) * (0.6 + Math.random()*1.4))); } return {labels,data}; }

/* --------------------------- Utilities: export / import / reset / persist --------------------------- */
function persistSubjects(){ localStorage.setItem('rt-subjects', JSON.stringify(SUBJECTS)); }
function loadSubjects(){ const s = localStorage.getItem('rt-subjects'); if(s) try{ const parsed = JSON.parse(s); Object.keys(parsed).forEach(k=> SUBJECTS[k]=parsed[k]); }catch(e){} }

elt('exportBtn').addEventListener('click', ()=>{ const model = SUBJECTS[currentSubjectKey]; const data = { subject: currentSubjectKey, sections: [] }; model.sections.forEach((sec,si)=>{ const s = { title: sec.title, topics: [] }; sec.topics.forEach((t,ti)=>{ s.topics.push({ title:t, done: localStorage.getItem(keyDone(currentSubjectKey,si,ti))==='true', note: localStorage.getItem(keyNote(currentSubjectKey,si,ti))||'', cycles: JSON.parse(localStorage.getItem(keyCycles(currentSubjectKey,si,ti)||'{}')||'{}'), sched: JSON.parse(localStorage.getItem(keySchedule(currentSubjectKey,si,ti)||'{}')||'{}') }); }); data.sections.push(s); }); const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`${currentSubjectKey}-export.json`; document.body.appendChild(a); a.click(); a.remove(); });

elt('importBtn').addEventListener('click', ()=>{ const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange = (e)=>{ const file = e.target.files[0]; if(!file) return; const r = new FileReader(); r.onload = ()=>{ try{ const parsed = JSON.parse(r.result); if(parsed.subject && parsed.sections){ if(!confirm('Import will overwrite local subject data. Continue?')) return; SUBJECTS[parsed.subject] = { title: parsed.subject, sections: parsed.sections.map(s=>({title:s.title, topics: s.topics.map(t=>t.title)})) }; // restore per-topic storage
                parsed.sections.forEach((sec,si)=> sec.topics.forEach((t,ti)=>{ if(t.done) localStorage.setItem(keyDone(parsed.subject,si,ti),'true'); else localStorage.removeItem(keyDone(parsed.subject,si,ti)); if(t.note) localStorage.setItem(keyNote(parsed.subject,si,ti), t.note); else localStorage.removeItem(keyNote(parsed.subject,si,ti)); if(t.cycles) localStorage.setItem(keyCycles(parsed.subject,si,ti), JSON.stringify(t.cycles)); else localStorage.removeItem(keyCycles(parsed.subject,si,ti)); if(t.sched) localStorage.setItem(keySchedule(parsed.subject,si,ti), JSON.stringify(t.sched)); else localStorage.removeItem(keySchedule(parsed.subject,si,ti)); })); persistSubjects(); alert('Import complete.'); renderAll(); } else alert('Invalid file.'); }catch(err){ alert('Failed to parse file'); } }; r.readAsText(file); }; inp.click(); });

elt('resetSub').addEventListener('click', ()=>{ if(!confirm('Reset progress for this subject?')) return; SUBJECTS[currentSubjectKey].sections.forEach((sec,si)=> sec.topics.forEach((t,ti)=>{ localStorage.removeItem(keyDone(currentSubjectKey,si,ti)); localStorage.removeItem(keyNote(currentSubjectKey,si,ti)); localStorage.removeItem(keyCycles(currentSubjectKey,si,ti)); localStorage.removeItem(keySchedule(currentSubjectKey,si,ti)); })); renderAll(); });

elt('resetAll').addEventListener('click', ()=>{ if(!confirm('Reset ALL subjects?')) return; Object.keys(SUBJECTS).forEach(sub=>{ SUBJECTS[sub].sections.forEach((sec,si)=> sec.topics.forEach((t,ti)=>{ localStorage.removeItem(keyDone(sub,si,ti)); localStorage.removeItem(keyNote(sub,si,ti)); localStorage.removeItem(keyCycles(sub,si,ti)); localStorage.removeItem(keySchedule(sub,si,ti)); })); }); renderAll(); });

/* --------------------------- Pomodoro (with looping alarm + silence button) --------------------------- */
let pomInterval = null; let pomRemain = 25*60; const alarm = elt('pomAlarm'); function updatePomDisplay(){ const mm = String(Math.floor(pomRemain/60)).padStart(2,'0'); const ss = String(pomRemain%60).padStart(2,'0'); elt('pomTimer').textContent = `${mm}:${ss}`; }
elt('startPom').addEventListener('click', ()=>{ if(pomInterval) clearInterval(pomInterval); pomRemain = 25*60; updatePomDisplay(); pomInterval = setInterval(()=>{ pomRemain--; updatePomDisplay(); if(pomRemain <= 0){ clearInterval(pomInterval); pomInterval = null; // play alarm (looping until user silences)
        try{ alarm.play(); }catch(e){ console.warn('alarm play failed'); }
        alert('Pomodoro finished — take a break!'); } }, 1000); });
elt('stopPom').addEventListener('click', ()=>{ if(pomInterval) clearInterval(pomInterval); pomInterval = null; pomRemain = 25*60; updatePomDisplay(); });
elt('silencePom').addEventListener('click', ()=>{ alarm.pause(); alarm.currentTime = 0; });

/* --------------------------- Subject create / delete --------------------------- */
elt('addSubBtn').addEventListener('click', ()=>{ const key = prompt('Enter a short key for the subject (no spaces):'); if(!key) return; if(SUBJECTS[key]) return alert('Subject key already exists'); const title = prompt('Display title for subject:','New Subject'); SUBJECTS[key] = { title: title||key, sections: [ { title: 'General', topics: [] } ] }; persistSubjects(); currentSubjectKey = key; localStorage.setItem('rt-sub', key); renderAll(); });
elt('delSubBtn').addEventListener('click', ()=>{ if(!confirm('Delete current subject and all its local progress?')) return; // remove per-topic storage
  const sub = currentSubjectKey; SUBJECTS[sub].sections.forEach((sec,si)=> sec.topics.forEach((t,ti)=>{ localStorage.removeItem(keyDone(sub,si,ti)); localStorage.removeItem(keyNote(sub,si,ti)); localStorage.removeItem(keyCycles(sub,si,ti)); localStorage.removeItem(keySchedule(sub,si,ti)); })); delete SUBJECTS[sub]; persistSubjects(); const keys = Object.keys(SUBJECTS); currentSubjectKey = keys[0]||null; if(currentSubjectKey) localStorage.setItem('rt-sub', currentSubjectKey); renderAll(); });

/* --------------------------- FAB add topic (first section) --------------------------- */
elt('fabAdd').addEventListener('click', ()=>{ const sub = currentSubjectKey; if(!sub) return alert('No subject selected'); const sIndex = 0; const title = prompt('Add topic title (it will be added to first section):'); if(title && title.trim()){ SUBJECTS[sub].sections[sIndex].topics.push(title.trim()); persistSubjects(); renderAll(); alert('Topic added to first section.'); } });

/* --------------------------- Schedule helpers & reminders --------------------------- */
function advanceDate(dateStr, freq){ if(!dateStr) return ''; const d = new Date(dateStr+'T00:00:00'); if(freq==='daily') d.setDate(d.getDate()+1); else if(freq==='weekly') d.setDate(d.getDate()+7); else if(freq==='monthly') d.setMonth(d.getMonth()+1); return d.toISOString().slice(0,10); }

// reminder check: runs every minute while page is open
function checkReminders(){ const today = new Date().toISOString().slice(0,10); Object.keys(SUBJECTS).forEach(sub=> SUBJECTS[sub].sections.forEach((sec,si)=> sec.topics.forEach((t,ti)=>{ const s = JSON.parse(localStorage.getItem(keySchedule(sub,si,ti) || '{}') || '{}'); if(!s.freq || !s.next) return; // scheduled
    // if due today or earlier and not completed today -> notify
    if(s.next <= today){ // check last completion date: we don't store per-date, but assume done flag indicates completion. To avoid repeated alerts, set a 'notifed' flag in schedule
      const completed = localStorage.getItem(keyDone(sub,si,ti)) === 'true'; const alreadyNotified = s.notified === today;
      if(!completed && !alreadyNotified){ sendReminder(`${SUBJECTS[sub].title} — ${t} is due today (${s.freq})`); s.notified = today; localStorage.setItem(keySchedule(sub,si,ti), JSON.stringify(s)); }
    }
  })) ); }

function sendReminder(text){ // visual + sound
  // try browser notification
  if(window.Notification && Notification.permission === 'granted'){ new Notification('Revision Reminder', { body: text }); }
  // also play a short beep (one-shot)
  const beep = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg'); beep.play().catch(()=>{});
}

elt('enableNotif').addEventListener('click', ()=>{ if(!window.Notification) return alert('Notifications not supported'); Notification.requestPermission().then(p=>{ if(p==='granted') alert('Notifications enabled'); else alert('Notifications denied'); }); });

/* --------------------------- init & helpers --------------------------- */
function renderAll(){ renderTabs(); renderTop(); renderSections(); }

function loadAll(){ loadSubjects(); renderAll(); updatePomDisplay(); }

// persistence on unload
window.addEventListener('beforeunload', ()=> persistSubjects());

// check reminders every 60s
setInterval(checkReminders, 60*1000); checkReminders();

// load saved subjects if any
loadAll();

// service worker (optional)
if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); }

</script>
</body>
</html>
